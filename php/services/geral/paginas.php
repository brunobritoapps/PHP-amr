<?phpclass paginas {    var $link;    function __construct() {        if (file_exists('parametros.php')) {            require_once('parametros.php');        } else {            require_once('..\parametros.php');        }        $this->link = conexao("base");    }    function getPaginas() {        $retorno = [];        $query = "SELECT p.*                    FROM paginas p                                        ORDER BY menu DESC,nivel,pai,ordem";        $params = array();        $resul = sqlsrv_query($this->link, $query, $params);        while ($linha = sqlsrv_fetch_object($resul)) {            $linha->nome = utf8_encode($linha->nome);            $retorno[$linha->id] = $linha;        }        return $retorno;    }    function getPaginasProjeto() {        $retorno = "";        $query = "SELECT p.permissao, pp.id_projeto                    FROM paginas p                    INNER JOIN paginas_projeto pp ON pp.id_pagina = p.id";        $params = array();        $resul = sqlsrv_query($this->link, $query, $params);        while ($linha = sqlsrv_fetch_object($resul)) {            $retorno[$linha->permissao][$linha->id_projeto] = 1;        }        return $retorno;    }    function validaService($usuario, $conta, $caminho, $classe, $funcao) {        $retorno = null;        if ($conta != 1) {            $query = "SELECT ISNULL(permissoes_contaf.id_permissao, -1) as conta, ISNULL(permissoes_nusuariof.id_permissao, -1) as usuario                    FROM permissoes_funcao                    LEFT JOIN permissoes_contaf ON permissoes_contaf.id_permissao = permissoes_funcao.id AND permissoes_contaf.id_conta=?                    LEFT JOIN permissoes_nusuariof ON permissoes_nusuariof.id_permissao = permissoes_funcao.id AND permissoes_nusuariof.id_usuario=?                    WHERE permissoes_funcao.caminho = ? AND permissoes_funcao.classe = ? AND permissoes_funcao.funcao = ?";            $params = array($conta, $usuario, $caminho, $classe, $funcao);            $resul = sqlsrv_query($this->link, $query, $params);            $retorno = sqlsrv_fetch_object($resul);        }        if (($retorno == null) || ($retorno->conta > 0 && $retorno->usuario == -1)) {            return true;        } else {            return false;        }    }    function logService($usuario, $funcao, $parametros, $hora, $duracao, $ambiente) {        $query = "INSERT INTO log_servicos(usuario, funcao, parametros, hora, duracao, ambiente) VALUES(?, ?, '" . $parametros . "', ?, ?, ?)";        $params = array($usuario, $funcao, $hora, $duracao, $ambiente);        $resul = sqlsrv_query($this->link, $query, $params);        $linha = sqlsrv_fetch_object($resul);    }    function validaPagina($usuario, $conta, $pagina) {        $retorno = null;        if ($conta != 1) {            $query = "SELECT ISNULL(permissoes_contap.id_permissao,-1)as conta,ISNULL(permissoes_nusuariop.id_permissao,-1)as usuario                        FROM paginas                        LEFT JOIN permissoes_contap ON permissoes_contap.id_permissao = paginas.id AND permissoes_contap.id_conta=?                        LEFT JOIN permissoes_nusuariop ON permissoes_nusuariop.id_permissao = paginas.id AND permissoes_nusuariop.id_usuario=?                        WHERE paginas.permissao=? AND paginas.verificar=1";            $params = array($conta, $usuario, $pagina);            $resul = sqlsrv_query($this->link, $query, $params);            $retorno = sqlsrv_fetch_object($resul);        }        if (($retorno == null) || ($retorno->conta > 0 && $retorno->usuario == -1)) {            return true;        } else {            return false;        }    }    function getServicesPerm($usuario, $conta) {        $retorno = array();        if ($conta != 1) {            $query = "SELECT permissoes_contaf.id_permissao                        FROM permissoes_contaf                        LEFT JOIN permissoes_nusuariof ON permissoes_nusuariof.id_permissao = permissoes_contaf.id_permissao AND permissoes_nusuariof.id_usuario={$usuario}                        WHERE permissoes_contaf.id_conta=?                        AND permissoes_nusuariof.id_permissao IS NULL";        } else {            $query = "SELECT id as id_permissao                        FROM permissoes_funcao";        }        $params = array($conta);        $resul = sqlsrv_query($this->link, $query, $params);        while ($linha = sqlsrv_fetch_object($resul)) {            $retorno[] = $linha;        }        return $retorno;    }    function getPaginaPerm($usuario, $conta) {        $retorno = array();        if ($conta != 1) {            $query = "SELECT permissoes_contap.id_permissao                        FROM permissoes_contap                        LEFT JOIN permissoes_nusuariop ON permissoes_nusuariop.id_permissao = permissoes_contap.id_permissao AND permissoes_nusuariop.id_usuario={$usuario}                        WHERE permissoes_contap.id_conta=?                        AND permissoes_nusuariop.id_permissao IS NULL";        } else {            $query = "SELECT id as id_permissao                        FROM paginas";        }        $params = array($conta);        $resul = sqlsrv_query($this->link, $query, $params);        while ($linha = sqlsrv_fetch_object($resul)) {            $retorno[] = $linha;        }        return $retorno;    }    function getArrPerm($usuario, $conta) {        $retorno = array();        $retorno["s"] = array();        $retorno["p"] = array();        $obj = new paginas();        $serv = $obj->getServicesPerm($usuario, $conta);        $pag = $obj->getPaginaPerm($usuario, $conta);        for ($i = 0; $i < count($serv); $i++) {            $retorno["s"][] = $serv[$i]->id_permissao;        }        for ($i = 0; $i < count($pag); $i++) {            $retorno["p"][] = $pag[$i]->id_permissao;        }        return $retorno;    }}?>